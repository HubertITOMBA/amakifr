###############################################################################
# Configuration Nginx pour le mode maintenance - AMAKI France
# 
# Ce fichier contient la configuration à ajouter dans votre bloc server nginx
# pour gérer le mode maintenance automatiquement.
#
# Fichier de configuration nginx principal (typiquement):
# /etc/nginx/sites-available/amaki
# ou
# /etc/nginx/conf.d/amaki.conf
###############################################################################

# IMPORTANT: Cette configuration doit être placée AVANT les directives location /

# Vérification du mode maintenance
# Si le fichier /sites/amakifr/maintenance.flag existe, rediriger vers la page de maintenance
set $maintenance 0;

# Détecter le mode maintenance via le fichier flag
if (-f /sites/amakifr/maintenance.flag) {
    set $maintenance 1;
}

# Exception pour les adresses IP administrateurs (optionnel)
# Décommentez et adaptez les IP selon vos besoins
# if ($remote_addr ~ "^(123.456.789.000|98.765.43.210)$") {
#     set $maintenance 0;
# }

# Redirection vers la page de maintenance
if ($maintenance = 1) {
    return 503;
}

# Configuration de la page d'erreur 503 (Service Unavailable)
error_page 503 @maintenance;

# Location pour servir la page de maintenance
location @maintenance {
    # Désactiver les restrictions d'accès pour la page de maintenance
    allow all;
    
    # Servir la page de maintenance depuis le fichier HTML statique
    root /sites/amakifr/.next/server/app;
    rewrite ^(.*)$ /maintenance.html break;
    
    # Headers pour éviter la mise en cache
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    add_header Pragma "no-cache";
    add_header Expires "0";
    
    # Type MIME
    default_type text/html;
}

# Permettre l'accès aux assets statiques même en mode maintenance (optionnel)
# Décommentez si vous voulez que les images/CSS/JS continuent de fonctionner
# location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
#     # Cette location sera accessible même en mode maintenance
#     root /sites/amakifr/public;
#     access_log off;
#     expires 30d;
# }


###############################################################################
# EXEMPLE DE CONFIGURATION COMPLÈTE NGINX
###############################################################################

# Voici un exemple de configuration nginx complète avec le mode maintenance :

# server {
#     listen 80;
#     listen [::]:80;
#     server_name votre-domaine.fr www.votre-domaine.fr;
#     
#     # Redirection HTTP vers HTTPS
#     return 301 https://$server_name$request_uri;
# }
# 
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name votre-domaine.fr www.votre-domaine.fr;
# 
#     # Certificats SSL
#     ssl_certificate /etc/letsencrypt/live/votre-domaine.fr/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/votre-domaine.fr/privkey.pem;
#     
#     # Configuration SSL moderne
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
# 
#     # Logs
#     access_log /var/log/nginx/amaki-access.log;
#     error_log /var/log/nginx/amaki-error.log;
# 
#     #########################################################################
#     # MODE MAINTENANCE - À PLACER ICI (AVANT LES LOCATIONS)
#     #########################################################################
#     
#     set $maintenance 0;
#     
#     if (-f /sites/amakifr/maintenance.flag) {
#         set $maintenance 1;
#     }
#     
#     if ($maintenance = 1) {
#         return 503;
#     }
#     
#     error_page 503 @maintenance;
#     
#     location @maintenance {
#         allow all;
#         root /sites/amakifr/.next/server/app;
#         rewrite ^(.*)$ /maintenance.html break;
#         add_header Cache-Control "no-store, no-cache, must-revalidate";
#         default_type text/html;
#     }
#     
#     #########################################################################
#     # FIN MODE MAINTENANCE
#     #########################################################################
# 
#     # Configuration Next.js
#     location / {
#         proxy_pass http://localhost:3000;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_cache_bypass $http_upgrade;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         
#         # Timeouts
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#     }
# 
#     # Assets statiques Next.js
#     location /_next/static {
#         alias /sites/amakifr/.next/static;
#         expires 365d;
#         access_log off;
#         add_header Cache-Control "public, immutable";
#     }
# 
#     # Assets publics
#     location /static {
#         alias /sites/amakifr/public;
#         expires 30d;
#         access_log off;
#     }
# 
#     # Fichiers publics
#     location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
#         root /sites/amakifr/public;
#         expires 30d;
#         access_log off;
#     }
# 
#     # Sécurité
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
# }


###############################################################################
# INSTRUCTIONS D'INSTALLATION
###############################################################################

# 1. Ouvrir le fichier de configuration nginx de votre site
#    sudo nano /etc/nginx/sites-available/amaki
#    ou
#    sudo nano /etc/nginx/conf.d/amaki.conf
#
# 2. Copier la section "MODE MAINTENANCE" ci-dessus
#    et la coller AVANT les directives "location /"
#
# 3. Adapter les chemins si nécessaire:
#    - /sites/amakifr/maintenance.flag (fichier flag)
#    - /sites/amakifr/.next/server/app (dossier de la page HTML)
#
# 4. Tester la configuration:
#    sudo nginx -t
#
# 5. Recharger nginx:
#    sudo systemctl reload nginx
#
# 6. Tester le mode maintenance:
#    bash scripts/maintenance-on.sh
#
# 7. Désactiver le mode maintenance:
#    bash scripts/maintenance-off.sh


###############################################################################
# DÉPANNAGE
###############################################################################

# Si la page de maintenance ne s'affiche pas:
# 
# 1. Vérifier que le fichier flag existe:
#    ls -la /sites/amakifr/maintenance.flag
#
# 2. Vérifier que la page HTML existe:
#    ls -la /sites/amakifr/.next/server/app/maintenance.html
#
# 3. Vérifier les logs nginx:
#    sudo tail -f /var/log/nginx/error.log
#
# 4. Vérifier la syntaxe nginx:
#    sudo nginx -t
#
# 5. Recharger nginx:
#    sudo systemctl reload nginx
#
# 6. Si nécessaire, redémarrer nginx:
#    sudo systemctl restart nginx


###############################################################################
# NOTES
###############################################################################

# - Le fichier flag (/sites/amakifr/maintenance.flag) est un simple fichier vide
#   qui sert de "switch" pour activer/désactiver le mode maintenance
#
# - Quand le fichier existe, nginx redirige vers la page de maintenance
#
# - Quand le fichier n'existe pas, nginx sert l'application normalement
#
# - La page se rafraîchit automatiquement toutes les 30 secondes pour vérifier
#   si l'application est de retour
#
# - Les headers Cache-Control empêchent la mise en cache de la page de maintenance
#
# - Vous pouvez ajouter des exceptions IP pour permettre aux admins d'accéder
#   au site même en mode maintenance (voir les commentaires ci-dessus)
