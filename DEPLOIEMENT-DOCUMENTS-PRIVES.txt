# DÃ©ploiement des Documents PrivÃ©s

## ğŸ“‹ Contexte

Les statuts de l'association (et autres documents sensibles) ne sont plus accessibles publiquement via le dossier `public/`. Ils sont maintenant stockÃ©s dans le dossier `private/documents/` et servis via une API route protÃ©gÃ©e qui vÃ©rifie l'authentification.

## ğŸ”’ SÃ©curitÃ©

- âœ… Les documents ne sont **plus dans Git** (dossier `private/` dans `.gitignore`)
- âœ… Accessible uniquement aux **adhÃ©rents connectÃ©s**
- âœ… VÃ©rification de l'authentification via **NextAuth**
- âœ… Protection contre les accÃ¨s non autorisÃ©s

## ğŸ“ Structure

```
private/
â””â”€â”€ documents/
    â”œâ”€â”€ README.md
    â””â”€â”€ statut-amaki-france.pdf
```

## ğŸš€ DÃ©ploiement en Production

### MÃ©thode 1 : Script automatique (recommandÃ©)

```bash
# Depuis votre machine locale
./scripts/deploy-private-documents.sh
```

Le script va :
1. VÃ©rifier les fichiers locaux
2. CrÃ©er le dossier sur le serveur
3. Copier les fichiers via SCP
4. DÃ©finir les bonnes permissions

### MÃ©thode 2 : DÃ©ploiement manuel

#### Ã‰tape 1 : Connexion au serveur

```bash
ssh root@amakifrance.com
cd /soft/dev/nextjs/amakifr
```

#### Ã‰tape 2 : CrÃ©er le dossier

```bash
mkdir -p private/documents
```

#### Ã‰tape 3 : Copier les fichiers

Depuis votre machine locale :

```bash
scp private/documents/statut-amaki-france.pdf root@amakifrance.com:/soft/dev/nextjs/amakifr/private/documents/
```

#### Ã‰tape 4 : VÃ©rifier les permissions

Sur le serveur :

```bash
chmod 644 private/documents/*.pdf
ls -lh private/documents/
```

### Ã‰tape 5 : RedÃ©marrer l'application

```bash
pm2 restart amakifr
```

## ğŸ§ª VÃ©rification

### Test 1 : Utilisateur non connectÃ©

```bash
curl -I https://amakifrance.com/api/documents/statut
# Devrait retourner: 401 Unauthorized
```

### Test 2 : Utilisateur connectÃ©

1. Se connecter sur https://amakifrance.com
2. Aller sur la page "L'amicale"
3. Cliquer sur "Nos Statuts"
4. Cliquer sur "TÃ©lÃ©charger le PDF"
5. Le PDF devrait s'ouvrir dans un nouvel onglet

### Test 3 : VÃ©rification sur le serveur

```bash
ssh root@amakifrance.com
ls -lh /soft/dev/nextjs/amakifr/private/documents/
# Devrait afficher:
# -rw-r--r--. 1 root root 759K ... statut-amaki-france.pdf
```

## ğŸ”„ Mise Ã  jour d'un document

Pour mettre Ã  jour un document (ex: nouveau statut) :

1. Remplacer le fichier local dans `private/documents/`
2. Relancer le script de dÃ©ploiement :
   ```bash
   ./scripts/deploy-private-documents.sh
   ```
3. RedÃ©marrer l'application sur le serveur :
   ```bash
   ssh root@amakifrance.com "cd /soft/dev/nextjs/amakifr && pm2 restart amakifr"
   ```

## ğŸ“š API Routes Disponibles

### GET /api/documents/statut

TÃ©lÃ©charge les statuts de l'association.

**Authentification** : Requise (session NextAuth)

**RÃ©ponse** :
- `200` : PDF des statuts
- `401` : Non authentifiÃ©
- `500` : Erreur serveur

**Headers** :
- `Content-Type: application/pdf`
- `Content-Disposition: inline; filename="statut-amaki-france.pdf"`
- `Cache-Control: private, max-age=3600`

## ğŸ› ï¸ Ajout de nouveaux documents

Pour ajouter un nouveau document privÃ© :

1. Placer le fichier dans `private/documents/`
2. CrÃ©er une nouvelle API route dans `app/api/documents/[nom]/route.ts`
3. Copier le code de `app/api/documents/statut/route.ts` et adapter
4. DÃ©ployer avec le script `./scripts/deploy-private-documents.sh`

## âš ï¸ Important

- Le dossier `private/` n'est **jamais commitÃ©** dans Git
- Les documents doivent Ãªtre **dÃ©ployÃ©s manuellement** sur chaque serveur
- En **dÃ©veloppement local**, placer les documents dans `private/documents/` pour les tester
- Sauvegarder les documents originaux dans un **lieu sÃ©curisÃ©** (hors Git)

## ğŸ› DÃ©pannage

### Erreur "Fichier introuvable"

VÃ©rifier que le fichier existe sur le serveur :
```bash
ls -lh /soft/dev/nextjs/amakifr/private/documents/
```

### Erreur "Permission denied"

VÃ©rifier les permissions :
```bash
chmod 644 /soft/dev/nextjs/amakifr/private/documents/*.pdf
```

### Erreur 401 mÃªme en Ã©tant connectÃ©

VÃ©rifier la session NextAuth :
- Effacer les cookies et se reconnecter
- VÃ©rifier les logs de l'application : `pm2 logs amakifr`
